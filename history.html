---
layout: default
title: Charging History
permalink: /history/
---

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card h3 {
        color: #667eea;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 10px;
    }
    .card .value {
        font-size: 2em;
        font-weight: bold;
        color: #333;
    }
    
    .controls {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .control-group {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .control-group label {
        font-weight: 600;
        color: #333;
    }
    
    select, button {
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
    }
    
    button {
        background: #667eea;
        color: white;
        border: none;
    }
    
    button:hover {
        background: #5568d3;
    }
    
    button:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .view-buttons {
        display: flex;
        gap: 5px;
    }
    
    .view-buttons button {
        padding: 6px 12px;
        font-size: 12px;
    }
    
    .view-buttons button.active {
        background: #333;
    }
    
    .chart-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        position: relative;
        height: 400px;
    }
    
    .sessions-table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        background: #f5f5f5;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
    }
    
    td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }
    
    tr:hover {
        background: #f9f9f9;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
    }
</style>

<h2>Charging History</h2>

<div class="controls">
    <div class="control-group">
        <label>Period:</label>
        <button id="prev-btn" onclick="previousPeriod()">← Previous</button>
        <span id="period-label" style="min-width: 150px; text-align: center; font-weight: 600;"></span>
        <button id="next-btn" onclick="nextPeriod()">Next →</button>
    </div>
    
    <div class="control-group">
        <label>View:</label>
        <div class="view-buttons">
            <button class="view-btn active" data-view="day" onclick="changeView('day')">Day</button>
            <button class="view-btn" data-view="month" onclick="changeView('month')">Month</button>
            <button class="view-btn" data-view="year" onclick="changeView('year')">Year</button>
        </div>
    </div>
    
    <div class="control-group">
        <label>Vehicle:</label>
        <select id="vehicle-filter" onchange="applyFilters()">
            <option value="all">All Vehicles</option>
            <option value="volvo">Volvo XC40</option>
            <option value="equinox">Equinox</option>
            <option value="unknown">Unknown</option>
        </select>
    </div>
    
    <div class="control-group">
        <label>Metric:</label>
        <select id="metric-filter" onchange="applyFilters()">
            <option value="energy">Energy (kWh)</option>
            <option value="miles">Miles Added</option>
            <option value="sessions">Session Count</option>
        </select>
    </div>
</div>

<div class="summary">
    <div class="card">
        <h3 id="stat1-label">Total Energy</h3>
        <div class="value" id="stat1-value">—</div>
    </div>
    <div class="card">
        <h3 id="stat2-label">Total Miles</h3>
        <div class="value" id="stat2-value">—</div>
    </div>
    <div class="card">
        <h3 id="stat3-label">Sessions</h3>
        <div class="value" id="stat3-value">—</div>
    </div>
</div>

<div class="chart-container">
    <canvas id="sessionChart"></canvas>
</div>

<h3>Session Details</h3>
<div class="sessions-table">
    <table>
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Vehicle</th>
                <th>Energy (kWh)</th>
                <th>Miles</th>
                <th>Duration</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody id="sessions-tbody">
            <tr><td class="no-data" colspan="6">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // State
    let allSessions = [];
    let currentView = 'day'; // day, month, year
    let currentDate = new Date();
    let chart = null;
    
    // Vehicle display names
    const vehicleNames = {
        'volvo': 'Volvo XC40',
        'equinox': 'Equinox',
        'unknown': 'Unknown'
    };
    
    // Vehicle efficiency (miles per kWh)
    const vehicleEfficiency = {
        'volvo': 2.56,      // ~256 mi / 100 kWh
        'equinox': 2.38,    // ~238 mi / 100 kWh
        'unknown': 2.5
    };
    
    async function discoverSessions() {
        /**
         * Discovers all session files recursively from data/sessions/ directory.
         * For now, loads from GitHub raw URL by constructing paths.
         */
        allSessions = [];
        
        // Known session files (will expand as new sessions are collected)
        const sessionPaths = [
            'data/sessions/2025/01/07/4751613101.json',
            'data/sessions/2025/01/08/4754846071.json',
            'data/sessions/2026/01/10/4758000341.json'
        ];
        
        for (const path of sessionPaths) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/scerruti/cph50-control/main/${path}?t=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Handle different session file formats
                    if (data.samples) {
                        // New format: collection data with samples
                        allSessions.push(parseCollectionSession(data));
                    } else if (data.session) {
                        // Old format: detailed session object
                        allSessions.push(parseDetailedSession(data));
                    }
                }
            } catch (e) {
                console.warn(`Could not load ${path}:`, e);
            }
        }
        
        // Sort by start time
        allSessions.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        console.log(`Loaded ${allSessions.length} sessions`);
    }
    
    function parseCollectionSession(data) {
        /**
         * Parse the collection_start format (5-minute sample collection)
         */
        const startTime = new Date(data.collection_start);
        const localStartTime = convertToLocalTime(startTime);
        
        // Find max energy reading from samples
        let energy = 0;
        if (data.samples && data.samples.length > 0) {
            const lastSample = data.samples[data.samples.length - 1];
            energy = lastSample.energy_kwh || 0;
        }
        
        // Estimate miles from energy and vehicle efficiency
        const vehicleId = data.vehicle_id || 'unknown';
        const efficiency = vehicleEfficiency[vehicleId] || 2.5;
        const miles = energy * efficiency;
        
        return {
            id: data.session_id,
            startTime: startTime,
            localStartTime: localStartTime,
            endTime: new Date(data.collection_end),
            duration: data.duration_seconds ? Math.round(data.duration_seconds / 60) : null,
            energy: energy,
            miles: miles,
            vehicleId: vehicleId,
            confidence: data.vehicle_confidence || 0,
            location: 'Home Charger'
        };
    }
    
    function parseDetailedSession(data) {
        /**
         * Parse the detailed session format (from ChargePoint API)
         */
        const session = data.session || {};
        const vehicle = data.vehicle || {};
        const location = data.location || {};
        
        const startTime = new Date(session.start_time || 0);
        const localStartTime = convertToLocalTime(startTime);
        const duration = session.session_time_ms ? Math.round(session.session_time_ms / 1000 / 60) : null;
        
        return {
            id: data.session_id,
            startTime: startTime,
            localStartTime: localStartTime,
            endTime: new Date(session.end_time || 0),
            duration: duration,
            energy: session.energy_kwh || 0,
            miles: session.miles_added || 0,
            vehicleId: data.vehicle_id || 'unknown',
            confidence: data.vehicle_confidence || 0,
            location: location.address || 'Unknown'
        };
    }
    
    function convertToLocalTime(utcDate) {
        /**
         * Convert UTC date to America/Los_Angeles time
         */
        return new Date(utcDate.toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }));
    }
    
    function applyFilters() {
        updateDisplay();
    }
    
    function changeView(view) {
        currentView = view;
        currentDate = new Date(); // Reset to today
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.view === view) btn.classList.add('active');
        });
        updateDisplay();
    }
    
    function previousPeriod() {
        if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() - 1);
        } else if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() - 1);
        } else {
            currentDate.setFullYear(currentDate.getFullYear() - 1);
        }
        updateDisplay();
    }
    
    function nextPeriod() {
        if (currentView === 'day') {
            currentDate.setDate(currentDate.getDate() + 1);
        } else if (currentView === 'month') {
            currentDate.setMonth(currentDate.getMonth() + 1);
        } else {
            currentDate.setFullYear(currentDate.getFullYear() + 1);
        }
        updateDisplay();
    }
    
    function getFilteredSessions() {
        const vehicleFilter = document.getElementById('vehicle-filter').value;
        const metricFilter = document.getElementById('metric-filter').value;
        
        return allSessions.filter(session => {
            if (vehicleFilter !== 'all' && session.vehicleId !== vehicleFilter) {
                return false;
            }
            
            // Check if session overlaps with current period
            const sessionInPeriod = isSessionInPeriod(session);
            return sessionInPeriod;
        });
    }
    
    function isSessionInPeriod(session) {
        const start = session.startTime;
        const end = session.endTime;
        
        let periodStart, periodEnd;
        
        if (currentView === 'day') {
            periodStart = new Date(currentDate);
            periodStart.setHours(0, 0, 0, 0);
            periodEnd = new Date(currentDate);
            periodEnd.setHours(23, 59, 59, 999);
        } else if (currentView === 'month') {
            periodStart = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            periodEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59, 999);
        } else {
            periodStart = new Date(currentDate.getFullYear(), 0, 1);
            periodEnd = new Date(currentDate.getFullYear(), 11, 31, 23, 59, 59, 999);
        }
        
        // Session overlaps period if it started before period ends and ended after period starts
        return start <= periodEnd && end >= periodStart;
    }
    
    function updateDisplay() {
        const filtered = getFilteredSessions();
        const metric = document.getElementById('metric-filter').value;
        
        // Update period label
        updatePeriodLabel();
        
        // Update navigation buttons
        document.getElementById('prev-btn').disabled = false;
        document.getElementById('next-btn').disabled = new Date() < getNextPeriodStart();
        
        // Calculate stats
        const stats = calculateStats(filtered, metric);
        updateStats(stats, metric);
        
        // Update chart
        updateChart(filtered, metric);
        
        // Update table
        updateSessionsTable(filtered);
    }
    
    function updatePeriodLabel() {
        let label = '';
        if (currentView === 'day') {
            label = currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' });
        } else if (currentView === 'month') {
            label = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        } else {
            label = currentDate.getFullYear().toString();
        }
        document.getElementById('period-label').textContent = label;
    }
    
    function getNextPeriodStart() {
        const next = new Date(currentDate);
        if (currentView === 'day') {
            next.setDate(next.getDate() + 1);
        } else if (currentView === 'month') {
            next.setMonth(next.getMonth() + 1);
        } else {
            next.setFullYear(next.getFullYear() + 1);
        }
        return next;
    }
    
    function calculateStats(sessions, metric) {
        let totalEnergy = 0, totalMiles = 0, totalSessions = sessions.length;
        
        sessions.forEach(s => {
            totalEnergy += s.energy || 0;
            totalMiles += s.miles || 0;
        });
        
        return { totalEnergy, totalMiles, totalSessions };
    }
    
    function updateStats(stats, metric) {
        const labels = {
            energy: ['Total Energy', 'Total Miles', 'Sessions'],
            miles: ['Total Miles', 'Total Energy', 'Sessions'],
            sessions: ['Sessions', 'Total Energy', 'Total Miles']
        };
        
        const values = {
            energy: [
                stats.totalEnergy.toFixed(1) + ' kWh',
                stats.totalMiles.toFixed(0) + ' mi',
                stats.totalSessions.toString()
            ],
            miles: [
                stats.totalMiles.toFixed(0) + ' mi',
                stats.totalEnergy.toFixed(1) + ' kWh',
                stats.totalSessions.toString()
            ],
            sessions: [
                stats.totalSessions.toString(),
                stats.totalEnergy.toFixed(1) + ' kWh',
                stats.totalMiles.toFixed(0) + ' mi'
            ]
        };
        
        const mapping = { energy: 0, miles: 1, sessions: 0 };
        document.getElementById('stat1-label').textContent = labels[metric][0];
        document.getElementById('stat1-value').textContent = values[metric][0];
        document.getElementById('stat2-label').textContent = labels[metric][1];
        document.getElementById('stat2-value').textContent = values[metric][1];
        document.getElementById('stat3-label').textContent = labels[metric][2];
        document.getElementById('stat3-value').textContent = values[metric][2];
    }
    
    function updateChart(sessions, metric) {
        const ctx = document.getElementById('sessionChart').getContext('2d');
        
        let labels, datasets;
        
        if (currentView === 'day') {
            // Hourly breakdown for current day
            labels = Array.from({length: 24}, (_, i) => `${i}:00`);
            const vehicleFilter = document.getElementById('vehicle-filter').value;
            
            // Group sessions by hour
            const hourlyData = {};
            sessions.forEach(s => {
                const hour = s.localStartTime.getHours();
                if (!hourlyData[hour]) hourlyData[hour] = [];
                hourlyData[hour].push(s);
            });
            
            const data = labels.map((_, hour) => {
                const hourSessions = hourlyData[hour] || [];
                if (metric === 'energy') {
                    return hourSessions.reduce((sum, s) => sum + s.energy, 0);
                } else if (metric === 'miles') {
                    return hourSessions.reduce((sum, s) => sum + s.miles, 0);
                } else {
                    return hourSessions.length;
                }
            });
            
            datasets = [{
                label: metric === 'energy' ? 'Energy (kWh)' : metric === 'miles' ? 'Miles' : 'Sessions',
                data: data,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }];
        } else if (currentView === 'month') {
            // Daily breakdown for current month
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            labels = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
            
            const dailyData = {};
            sessions.forEach(s => {
                const day = s.localStartTime.getDate();
                if (s.localStartTime.getMonth() === month && s.localStartTime.getFullYear() === year) {
                    if (!dailyData[day]) dailyData[day] = [];
                    dailyData[day].push(s);
                }
            });
            
            const data = labels.map((_, i) => {
                const day = i + 1;
                const daySessions = dailyData[day] || [];
                if (metric === 'energy') {
                    return daySessions.reduce((sum, s) => sum + s.energy, 0);
                } else if (metric === 'miles') {
                    return daySessions.reduce((sum, s) => sum + s.miles, 0);
                } else {
                    return daySessions.length;
                }
            });
            
            datasets = [{
                label: metric === 'energy' ? 'Energy (kWh)' : metric === 'miles' ? 'Miles' : 'Sessions',
                data: data,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }];
        } else {
            // Monthly breakdown for current year
            labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const monthlyData = {};
            sessions.forEach(s => {
                if (s.localStartTime.getFullYear() === currentDate.getFullYear()) {
                    const month = s.localStartTime.getMonth();
                    if (!monthlyData[month]) monthlyData[month] = [];
                    monthlyData[month].push(s);
                }
            });
            
            const data = Array.from({length: 12}, (_, month) => {
                const monthSessions = monthlyData[month] || [];
                if (metric === 'energy') {
                    return monthSessions.reduce((sum, s) => sum + s.energy, 0);
                } else if (metric === 'miles') {
                    return monthSessions.reduce((sum, s) => sum + s.miles, 0);
                } else {
                    return monthSessions.length;
                }
            });
            
            datasets = [{
                label: metric === 'energy' ? 'Energy (kWh)' : metric === 'miles' ? 'Miles' : 'Sessions',
                data: data,
                backgroundColor: 'rgba(102, 126, 234, 0.6)',
                borderColor: 'rgba(102, 126, 234, 1)',
                borderWidth: 1
            }];
        }
        
        if (chart) chart.destroy();
        
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: metric === 'energy' ? 'Energy (kWh)' : metric === 'miles' ? 'Miles' : 'Count'
                        }
                    }
                }
            }
        });
    }
    
    function updateSessionsTable(sessions) {
        const tbody = document.getElementById('sessions-tbody');
        
        if (sessions.length === 0) {
            tbody.innerHTML = '<tr><td class="no-data" colspan="6">No sessions for this period</td></tr>';
            return;
        }
        
        // Sort by start time descending
        const sorted = [...sessions].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        
        tbody.innerHTML = sorted.map(s => `
            <tr>
                <td>${formatDateTime(s.localStartTime)}</td>
                <td>${vehicleNames[s.vehicleId] || s.vehicleId}</td>
                <td>${s.energy.toFixed(1)}</td>
                <td>${s.miles.toFixed(1)}</td>
                <td>${s.duration ? s.duration + ' min' : '—'}</td>
                <td>${s.location}</td>
            </tr>
        `).join('');
    }
    
    function formatDateTime(date) {
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Initialize
    async function init() {
        await discoverSessions();
        updateDisplay();
    }
    
    init();
</script>
