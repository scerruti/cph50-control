name: Nightly Charger Check (8 PM PST)

on:
  schedule:
    # Run at 4:00 AM UTC (8:00 PM PST previous day)
    # Run at 5:00 AM UTC (8:00 PM PDT previous day)
    - cron: '0 4,5 * * *'
  workflow_dispatch: # Manual trigger for testing

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-chargepoint requests
    
    - name: Check charger and notify if offline
      env:
        CP_USERNAME: ${{ secrets.CP_USERNAME }}
        CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
        IFTTT_WEBHOOK_KEY: ${{ secrets.IFTTT_WEBHOOK_KEY }}
        ALERT_EMAIL: ${{ secrets.ALERT_EMAIL }}
        NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
        NTFY_URL: ${{ secrets.NTFY_URL }}
        SMTP_HOST: ${{ secrets.SMTP_HOST }}
        SMTP_PORT: ${{ secrets.SMTP_PORT }}
        SMTP_USER: ${{ secrets.SMTP_USER }}
        SMTP_PASS: ${{ secrets.SMTP_PASS }}
        FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
      run: |
        python3 << 'EOF'
        import os
        import smtplib
        import ssl
        import requests
        from datetime import datetime
        from zoneinfo import ZoneInfo
        from python_chargepoint import ChargePoint

        print("=" * 60)
        print("Nightly Charger Status Check (8 PM PST)")
        print(f"UTC Time: {datetime.now(ZoneInfo('UTC')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print(f"PST Time: {datetime.now(ZoneInfo('America/Los_Angeles')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print("=" * 60)

        # Check if it's actually 8 PM PST
        pacific = ZoneInfo("America/Los_Angeles")
        now = datetime.now(pacific)
        if now.hour != 20:
            print(f"\nâ„¹ï¸  Not 8 PM PST (current hour: {now.hour})")
            print("Exiting without notification")
            exit(0)

        print("\nðŸ•— It's 8 PM PST - checking charger status...")

        username = os.environ.get("CP_USERNAME")
        password = os.environ.get("CP_PASSWORD")
        ifttt_key = os.environ.get("IFTTT_WEBHOOK_KEY")
        alert_email = os.environ.get("ALERT_EMAIL")
        ntfy_topic = os.environ.get("NTFY_TOPIC")
        ntfy_url = os.environ.get("NTFY_URL", "https://ntfy.sh")
        smtp_host = os.environ.get("SMTP_HOST")
        smtp_port = os.environ.get("SMTP_PORT")
        smtp_user = os.environ.get("SMTP_USER")
        smtp_pass = os.environ.get("SMTP_PASS")
        from_email = os.environ.get("FROM_EMAIL")

        try:
            print(f"ðŸ” Authenticating as {username}...")
            client = ChargePoint(username=username, password=password)
            print("âœ“ Authentication successful\n")
            
            print("ðŸ” Fetching charger status...")
            chargers = client.get_home_chargers()
            
            if not chargers:
                print("âŒ No chargers found")
                exit(1)
            
            charger_id = chargers[0]
            status = client.get_home_charger_status(charger_id)
            
            print(f"ðŸ“Š Charger {charger_id}:")
            print(f"   Connected: {status.connected}")
            print(f"   Plugged In: {status.plugged_in}")
            print(f"   Last Connected: {status.last_connected_at}")
            
            if status.connected:
                print("\nâœ… Charger is ONLINE - no notification needed")
                exit(0)
            
            # Charger is offline - send notifications
            print("\nâš ï¸  CHARGER IS OFFLINE - Sending notifications...")
            
            # Send IFTTT webhook for Google Home broadcast
            if ifttt_key:
                ifttt_event = "charger_offline"
                ifttt_url = f"https://maker.ifttt.com/trigger/{ifttt_event}/with/key/{ifttt_key}"
                
                payload = {
                    "value1": "Your EV charger is offline",
                    "value2": f"Last seen: {status.last_connected_at}",
                    "value3": "Please check the charger and WiFi connection"
                }
                
                try:
                    response = requests.post(ifttt_url, json=payload, timeout=10)
                    if response.status_code == 200:
                        print("âœ“ IFTTT webhook sent (Google Home broadcast)")
                    else:
                        print(f"âš ï¸  IFTTT webhook failed: {response.status_code}")
                except Exception as e:
                    print(f"âš ï¸  IFTTT webhook error: {str(e)}")
            else:
                print("â„¹ï¸  No IFTTT_WEBHOOK_KEY configured - skipping Google Home broadcast")

              # Send ntfy.sh push notification (free, no account needed)
              if ntfy_topic:
                ntfy_endpoint = f"{ntfy_url.rstrip('/')}/{ntfy_topic}"
                message = "EV charger is offline. Please check charger and WiFi."
                try:
                  resp = requests.post(
                    ntfy_endpoint,
                    data=message.encode("utf-8"),
                    headers={"Title": "EV Charger Offline", "Priority": "high"},
                    timeout=10,
                  )
                  if resp.status_code < 300:
                    print("âœ“ ntfy.sh push sent")
                  else:
                    print(f"âš ï¸  ntfy.sh push failed: {resp.status_code}")
                except Exception as e:
                  print(f"âš ï¸  ntfy.sh error: {e}")
              else:
                print("â„¹ï¸  No NTFY_TOPIC configured - skipping ntfy.sh push")

              # Send email notification (SMTP)
              if alert_email and smtp_host and smtp_port and smtp_user and smtp_pass and from_email:
                body = (
                  "Subject: EV Charger Offline\n\n"
                  "Your EV charger is offline at 8 PM.\n"
                  f"Last seen: {status.last_connected_at}\n"
                  "Please check power and WiFi."
                )
                try:
                  context = ssl.create_default_context()
                  with smtplib.SMTP(smtp_host, int(smtp_port)) as server:
                    server.starttls(context=context)
                    server.login(smtp_user, smtp_pass)
                    server.sendmail(from_email, [alert_email], body)
                  print("âœ“ Email sent")
                except Exception as e:
                  print(f"âš ï¸  Email send failed: {e}")
              elif alert_email:
                print("â„¹ï¸  ALERT_EMAIL set but SMTP details missing; skipping email")
              else:
                print("â„¹ï¸  No ALERT_EMAIL configured - skipping email")
            
            # Optional: Send email notification
            if alert_email:
                print(f"â„¹ï¸  Alert email configured for {alert_email}")
                print("   (Email sending not implemented - use IFTTT for Google Home)")
            
            print("\n" + "=" * 60)
            print("âœ… Notification process completed")
            print("=" * 60)
            
        except Exception as e:
            print(f"\nâŒ ERROR: {type(e).__name__}: {str(e)}")
            exit(1)
        EOF
