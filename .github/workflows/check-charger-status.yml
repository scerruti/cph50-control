name: Check Charger Status

on:
  workflow_dispatch: # Manual trigger only
  schedule:
    # Run every 6 hours for monitoring
    - cron: '0 */6 * * *'

jobs:
  check-status:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install python-chargepoint
    
    - name: Check charger status
      env:
        CP_USERNAME: ${{ secrets.CP_USERNAME }}
        CP_PASSWORD: ${{ secrets.CP_PASSWORD }}
      run: |
        python3 << 'EOF'
        import os
        from datetime import datetime
        from zoneinfo import ZoneInfo
        from python_chargepoint import ChargePoint

        print("=" * 60)
        print("CPH50 Charger Status Check")
        print(f"UTC Time: {datetime.now(ZoneInfo('UTC')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print(f"PST Time: {datetime.now(ZoneInfo('America/Los_Angeles')).strftime('%Y-%m-%d %H:%M:%S %Z')}")
        print("=" * 60)

        username = os.environ.get("CP_USERNAME")
        password = os.environ.get("CP_PASSWORD")

        try:
            print(f"\nðŸ” Authenticating as {username}...")
            client = ChargePoint(username=username, password=password)
            print("âœ“ Authentication successful\n")
            
            print("ðŸ” Fetching home chargers...")
            chargers = client.get_home_chargers()
            
            if not chargers:
                print("âŒ No chargers found")
                exit(1)
            
            print(f"âœ“ Found {len(chargers)} charger(s)\n")
            
            for charger_id in chargers:
                print(f"ðŸ“Š Charger ID: {charger_id}")
                print("-" * 60)
                
                status = client.get_home_charger_status(charger_id)
                
                print(f"  Model:          {status.model}")
                print(f"  Connected:      {status.connected} {'âœ…' if status.connected else 'âŒ'}")
                print(f"  Plugged In:     {status.plugged_in} {'âœ…' if status.plugged_in else 'âŒ'}")
                print(f"  Charging Status: {status.charging_status}")
                print(f"  Last Connected: {status.last_connected_at}")
                
                if hasattr(status, 'port_number'):
                    print(f"  Port Number:    {status.port_number}")
                if hasattr(status, 'mac_address'):
                    print(f"  MAC Address:    {status.mac_address}")
                
                print()
                
                if status.charging_status == "CHARGING":
                    print("âš¡ Charger is ACTIVELY CHARGING")
                elif status.connected and status.plugged_in:
                    print("âœ… Charger is READY to charge (vehicle plugged in, not charging)")
                elif status.connected and not status.plugged_in:
                    print("âš ï¸  Charger is online but NO VEHICLE plugged in")
                elif not status.connected:
                    print("âŒ Charger is OFFLINE (not connected to network)")
                    print("   â†’ Restart charger (unplug 30 sec)")
                    print("   â†’ Check WiFi connection")
                    print("   â†’ Verify in ChargePoint app")
                
                print()
            
            print("=" * 60)
            
        except Exception as e:
            print(f"\nâŒ ERROR: {type(e).__name__}: {str(e)}")
            exit(1)
        EOF
